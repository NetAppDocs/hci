---
sidebar: docs_sidebar
permalink: docs/task_upgrade_compute_prechecks.html
summary: As part of a NetApp HCI system upgrade, you need to run compute node health checks before performing firwamre upgrades.
keywords: netapp, compute prechecks, compute node upgrade, netapp hci
---

= Run compute node health checks prior to upgrading compute firmware

:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ../media/

[.lead]
You must run health checks prior to upgrading compute firmware to ensure all compute nodes in your cluster are ready to be upgraded.

You can run health checks using NetApp Hybrid Cloud Control (HCC) UI or HCC API:

* <<Use NetApp Hybrid Cloud Control to run compute node health checks prior to upgrading firmware>> (Preferred method)
* <<Use API to run compute node health checks prior to upgrading firmware>>

You can also find out more about compute node health checks that are run by the service:

* <<Compute node health checks made by the service>>

.What you'll need

* You have updated to the latest management services bundle (2.11 or later).
* You are running management node 11.3 or later.
* Your cluster version is running NetApp Element software 11.3 or later.

== Use NetApp Hybrid Cloud Control to run compute node health checks prior to upgrading firmware

Using NetApp Hybrid Cloud Control (HCC), you can verify that a compute node is ready for a firmware upgrade.

.Steps

. Open a web browser and browse to the IP address of the management node:
+
----
https://<ManagementNodeIP>
----
. Log in to NetApp Hybrid Cloud Control by providing the storage cluster administrator credentials.
. Click *Upgrade* near the top right of the interface.
. On the *Upgrades* page, select the *Compute firmware* tab.
. Click the health check image:hcc_healthcheck_icon.png[icon] for the cluster you want to check for upgrade readiness.
. On the *Compute Health Check* page, click *Run Health Check*.
. If there are issues, do the following:
.. Go to the specific KB article listed for each issue or perform the specified remedy.
.. If a KB is specified, complete the process described in the relevant KB article.
.. After you have resolved cluster issues, click *Re-Run Health Check*.

After the health check completes without errors, the compute nodes in the cluster are ready to upgrade. See  link:task_hcc_upgrade_compute_node_firmware.html[Update compute node firmware] to proceed.

== Use API to run compute node health checks prior to upgrading firmware

You can use REST API to verify that compute nodes in a cluster are  ready to be upgraded. The health check verifies that there are no obstacles to upgrading, such as ESXi host issues or other vSphere issues.

.Steps

. Locate the storage cluster ID:
.. Open the management node REST API UI on the management node:
+
----
https://[management node IP]/mnode
----
.. Click *Authorize* and complete the following:
... Enter the cluster user name and password.
... Enter the client ID as `mnode-client` if the value is not already populated.
... Click *Authorize* to begin a session.
.. From the REST API UI, click *GET /assets/controllers*.
.. Click *Try it out*.
.. Click *Execute*.
.. From the response, copy the following:
... The storage cluster host name  (`"host_name"`).
... The storage controller ID (`"id"`).
... The compute ESXi host names (`"host_name"`)
. Run health checks on the compute nodes in the cluster:
.. Open the compute service REST API UI on the management node:
+
----
https://[management node IP]/vcenter/1
----
.. Click *Authorize* and complete the following:
... Enter the cluster user name and password.
... Enter the client ID as `mnode-client` if the value is not already populated.
... Click *Authorize* to begin a session.
.. Click *POST /compute​/{CONTROLLER_ID}​/health-checks*.
.. Click *Try it out*.
.. Enter the controller ID in the parameter field.
.. In the payload, enter the vCenter cluster ID and vCenter host ID for each compute ESXi host.
.. Click *Execute* to run a health check on the specified cluster and nodes.
+
The response should indicate the task name as `Performing health checks` and give a task ID.
.. Copy the `taskId` that is part of response.
. (Optional) Verify the status of the health checks:
.. Open the task monitor REST API UI on the management node:
+
----
https://[management node IP]/task-monitor/1
----
.. Click *Authorize* and complete the following:
... Enter the cluster user name and password.
... Enter the client ID as `mnode-client` if the value is not already populated.
... Click *Authorize* to begin a session.
.. Click *GET /tasks/{TASK_ID}*.
.. Click *Try it out*.
.. Enter the `taskId` in the parameter field.
.. Click *Execute*.
.. Scroll to the bottom of the response body to verify that the task completed.
. Verify the results of the health checks:
.. Open the compute service REST API UI on the management node:
+
----
https://[management node IP]/vcenter/1
----
.. Click *Authorize* and complete the following:
... Enter the cluster user name and password.
... Enter the client ID as `mnode-client` if the value is not already populated.
... Click *Authorize* to begin a session.
.. Click *POST /compute​/tasks/[task_id}*.
.. Click *Try it out*.
.. Enter the `task_id` in the parameter field.
.. Click *Execute*.
.. If the `customerResolution` returned indicates that there were problems regarding compute node health, do the following:
... Go to the specific KB article (`KbLink`) listed for each issue or perform the specified remedy.
... If a KB is specified, complete the process described in the relevant KB article.
... After you have resolved cluster issues, run *POST /compute​/{CONTROLLER_ID}​/health-checks* again (see step 2).

If all health checks are successful, the return is similar to the following example:
----
"message": "All checks completed successfully.",
"percent": 100,
"timestamp": "2020-03-06T00:03:16.321621Z"
----

== Compute node health checks made by the service
Compute health checks, whether performed by HCC or API methods, make the following checks per node.
|===
| Check description | Node/cluster | Action needed to resolve | Knowledgebase article with procedure

| Is DRS enabled and fully automated? | Cluster | Turn on DRS and make sure it is fully automated. | link:https://kb.netapp.com/app/answers/answer_view/a_id/1095730[See this KB].

| Is DPM disabled in vSphere? | Cluster | Turn off Distributed Power Management. | link:https://kb.netapp.com/app/answers/answer_view/a_id/1095731[See this KB].

| Is HA admission control enabled in vSphere? | Cluster | Turn off HA admission control. | link:https://kb.netapp.com/app/answers/answer_view/a_id/1095732[See this KB].

| Is FT enabled for a VM on a host in the cluster? | Node |  	Suspend Fault Tolerance on any affected virtual machines. | link:https://kb.netapp.com/app/answers/answer_view/a_id/1095733[See this KB].

| Are there critical alarms in vCenter for the cluster? | Cluster | Launch vSphere and resolve and/or acknowledge any alerts before proceeding. | No KB needed to resolve issue.

| Are there generic/global informational alerts in vCenter? | Cluster |  	Launch vSphere and resolve and/or acknowledge any alerts before proceeding. | No KB needed to resolve issue.

| Are management services up to date? | HCI system | You must update management services before you perform an upgrade or run pre-upgrade health checks. | No KB needed to resolve issue

| Are there errors on the current ESXi node in vSphere? | Node | Launch vSphere and resolve and/or acknowledge any alerts before proceeding. | No KB needed to resolve issue

| Is virtual media mounted to a VM on a host in the cluster? | Node | Unmount all virtual media disks (CD/DVD/floppy) from the VMs. | No KB needed to resolve issue

| Is BMC version the minimum required version that has RedFish support? | Node | Manually update your BMC firmware. | No KB needed to resolve issue

| Is ESXi host up and running? | Node | Start your ESXi host. | No KB needed to resolve issue

| Is ESXi host in maintenance mode? | Node | Your ESXi host should be placed in maintenance mode prior to updating firmware. | No KB needed to resolve issue

| Is BMC up and running? | Node | Power on your BMC and ensure it is connected to a network this management node can reach. | No KB needed to resolve issue

| Are there partner ESXi host(s) available? | Node | Make one or more ESXi host(s) in cluster available (not in maintenance mode) to migrate virtual machines. | No KB needed to resolve issue
|===

[discrete]
== Find more information

* https://docs.netapp.com/hci/index.jsp[NetApp HCI Documentation Center^]
* https://docs.netapp.com/us-en/documentation/hci.aspx[NetApp HCI Resources Page^]
